<section class="post-terminal   ">

    <article class="post-terminal__article">
<section class="post-header mb-8">
    <h1 id="title" style="font-size: 4rem; line-height: 1.1; font-weight: 800;" class="text-6xl md:text-7xl font-extrabold gradient-text mb-4 post-title-large">I was wrecked by a weird combo of >> and -e</h1>
    <div class="flex items-center text-sm text-text-main/80 mb-6">
        <time datetime="2025-04-23">
            April 23, 2025
        </time>
    </div>
    <div class="flex flex-wrap gap-2">
            <a href="https://pype.dev//tags/linux/" class="inline-block bg-primary-light text-accent-cool text-xs font-medium px-3 py-1 rounded-full hover:bg-primary-light/80 transition-colors border border-accent-cool/20 hover-lift">
                #linux
            </a>
            <a href="https://pype.dev//tags/cli/" class="inline-block bg-primary-light text-accent-cool text-xs font-medium px-3 py-1 rounded-full hover:bg-primary-light/80 transition-colors border border-accent-cool/20 hover-lift">
                #cli
            </a>
            <a href="https://pype.dev//tags/tech/" class="inline-block bg-primary-light text-accent-cool text-xs font-medium px-3 py-1 rounded-full hover:bg-primary-light/80 transition-colors border border-accent-cool/20 hover-lift">
                #tech
            </a>
    </div>
</section>        <section class="post-terminal__body prose dark:prose-invert">
            <h2 id="tldr">TL;DR <a class="header-anchor" href="#tldr"><svg class="heading-permalink" aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></a></h2>
<p>If state matters then check it in the beginning or handle it on a failure... Let me explain</p>
<p>I ran into some trouble recently <em>almost</em> losing some encrypted data... Now
this would be the second time I've had that happen, so I'm going to write a
little bit about it now that I figured it out</p>
<h2 id="the-stage">The Stage <a class="header-anchor" href="#the-stage"><svg class="heading-permalink" aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></a></h2>
<p>Here's the scenario - I use <code>ansible-vault</code> to keep some sensitive data in a
few public repos, and I keep the keys I use in Bitwarden Secrets Manager.</p>
<p>I use <code>just</code> as a command runner and have common <code>just encrypt</code> and <code>just decrypt</code> recipes throughout many justfiles. It might look something like this</p>
<pre class='wrapper'>

<div class='copy-wrapper'>

<button class='copy' title='copy code to clipboard' onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('pre').textContent)"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 115.77 122.88" style="enable-background:new 0 0 115.77 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M89.62,13.96v7.73h12.19h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02v0.02 v73.27v0.01h-0.02c-0.01,3.84-1.57,7.33-4.1,9.86c-2.51,2.5-5.98,4.06-9.82,4.07v0.02h-0.02h-61.7H40.1v-0.02 c-3.84-0.01-7.34-1.57-9.86-4.1c-2.5-2.51-4.06-5.98-4.07-9.82h-0.02v-0.02V92.51H13.96h-0.01v-0.02c-3.84-0.01-7.34-1.57-9.86-4.1 c-2.5-2.51-4.06-5.98-4.07-9.82H0v-0.02V13.96v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07V0h0.02h61.7 h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02V13.96L89.62,13.96z M79.04,21.69v-7.73v-0.02h0.02 c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v64.59v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h12.19V35.65 v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07v-0.02h0.02H79.04L79.04,21.69z M105.18,108.92V35.65v-0.02 h0.02c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v73.27v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h61.7h0.02 v0.02c0.91,0,1.75-0.39,2.37-1.01c0.61-0.61,1-1.46,1-2.37h-0.02V108.92L105.18,108.92z"/></g></svg></button>
</div>
        
<div class="highlight"><pre><span></span>get-vault-key:
<span class="w">    </span>bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>

encrypt:
<span class="w">    </span><span class="c1">#!/bin/bash</span>
<span class="w">    </span><span class="nb">set</span><span class="w"> </span>+e
<span class="w">    </span>just<span class="w"> </span>get-vault-key<span class="w"> </span>&gt;<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>./secret-file<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>./secret-file2<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>rm<span class="w"> </span>key

decrypt:
<span class="w">    </span><span class="c1">#!/bin/bash</span>
<span class="w">    </span><span class="nb">set</span><span class="w"> </span>+e
<span class="w">    </span>just<span class="w"> </span>get-vault-key<span class="w"> </span>&gt;<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>./secret-file<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>./secret-file2<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>rm<span class="w"> </span>key
</pre></div>

</pre>

<h2 id="spoiler">Spoiler <a class="header-anchor" href="#spoiler"><svg class="heading-permalink" aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></a></h2>
<p>Above is a good example of the 2 recipes, but prior to this morning they looked like this</p>
<pre class='wrapper'>

<div class='copy-wrapper'>

<button class='copy' title='copy code to clipboard' onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('pre').textContent)"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 115.77 122.88" style="enable-background:new 0 0 115.77 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M89.62,13.96v7.73h12.19h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02v0.02 v73.27v0.01h-0.02c-0.01,3.84-1.57,7.33-4.1,9.86c-2.51,2.5-5.98,4.06-9.82,4.07v0.02h-0.02h-61.7H40.1v-0.02 c-3.84-0.01-7.34-1.57-9.86-4.1c-2.5-2.51-4.06-5.98-4.07-9.82h-0.02v-0.02V92.51H13.96h-0.01v-0.02c-3.84-0.01-7.34-1.57-9.86-4.1 c-2.5-2.51-4.06-5.98-4.07-9.82H0v-0.02V13.96v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07V0h0.02h61.7 h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02V13.96L89.62,13.96z M79.04,21.69v-7.73v-0.02h0.02 c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v64.59v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h12.19V35.65 v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07v-0.02h0.02H79.04L79.04,21.69z M105.18,108.92V35.65v-0.02 h0.02c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v73.27v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h61.7h0.02 v0.02c0.91,0,1.75-0.39,2.37-1.01c0.61-0.61,1-1.46,1-2.37h-0.02V108.92L105.18,108.92z"/></g></svg></button>
</div>
        
<div class="highlight"><pre><span></span>get-vault-key:
<span class="w">    </span>bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>

<span class="c1"># BAD EXAMPLES! DO NOT DO THIS</span>

encrypt:
<span class="w">    </span><span class="nb">set</span><span class="w"> </span>-e
<span class="w">    </span>just<span class="w"> </span>get-vault-key<span class="w"> </span>&gt;&gt;<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>./secret-file<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>encrypt<span class="w"> </span>./secret-file2<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>rm<span class="w"> </span>key

decrypt:
<span class="w">    </span><span class="nb">set</span><span class="w"> </span>-e
<span class="w">    </span>just<span class="w"> </span>get-vault-key<span class="w"> </span>&gt;&gt;<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>./secret-file<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>ansible-vault<span class="w"> </span>decrypt<span class="w"> </span>./secret-file2<span class="w"> </span>--vault-password-file<span class="w"> </span>key
<span class="w">    </span>rm<span class="w"> </span>key
</pre></div>

</pre>

<h2 id="problem">Problem <a class="header-anchor" href="#problem"><svg class="heading-permalink" aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></a></h2>
<p>So here's the story - in real life I started using distrobox when I ran into
this and I thought it was an issue with different versions of ansible installed
in distrobox and on my desktop. After a few more odd deployment workflows I
think I've determined that the real problem is that <code>&gt;&gt;</code> appends to a file (see
the issue yet?), but if my recipes fail (say I try to encrypt an already
encrypted file) then the command exits but what's left on my disk? <code>key</code> is
still there... and the next time I go to run a command I'll echo the real key
to the <code>key</code> file again and if I called <code>encrypt</code> when the first or more files
in the list were <code>decrypted</code> then they'll be encrypted not with my key, but
with my key repeated as many times as I ran a command with <code>just get-vault-key &gt;&gt; key</code>
before ever removing the key file!</p>
<pre class='wrapper'>

<div class='copy-wrapper'>

<button class='copy' title='copy code to clipboard' onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('pre').textContent)"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 115.77 122.88" style="enable-background:new 0 0 115.77 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M89.62,13.96v7.73h12.19h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02v0.02 v73.27v0.01h-0.02c-0.01,3.84-1.57,7.33-4.1,9.86c-2.51,2.5-5.98,4.06-9.82,4.07v0.02h-0.02h-61.7H40.1v-0.02 c-3.84-0.01-7.34-1.57-9.86-4.1c-2.5-2.51-4.06-5.98-4.07-9.82h-0.02v-0.02V92.51H13.96h-0.01v-0.02c-3.84-0.01-7.34-1.57-9.86-4.1 c-2.5-2.51-4.06-5.98-4.07-9.82H0v-0.02V13.96v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07V0h0.02h61.7 h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02V13.96L89.62,13.96z M79.04,21.69v-7.73v-0.02h0.02 c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v64.59v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h12.19V35.65 v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07v-0.02h0.02H79.04L79.04,21.69z M105.18,108.92V35.65v-0.02 h0.02c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v73.27v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h61.7h0.02 v0.02c0.91,0,1.75-0.39,2.37-1.01c0.61-0.61,1-1.46,1-2.37h-0.02V108.92L105.18,108.92z"/></g></svg></button>
</div>
        
<div class="highlight"><pre><span></span>nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>cat<span class="w"> </span>secret-file
Danger,<span class="w"> </span>Will<span class="w"> </span>Robinson

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>just<span class="w"> </span>encrypt
bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>
Encryption<span class="w"> </span>successful

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>cat<span class="w"> </span>secret-file
<span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span><span class="m">1</span>.1<span class="p">;</span>AES256
<span class="m">39616332393662346639633030633766666336323939346138633238626239363733316431333737</span>
6463663763366434376437303335643431663431326135300a636261663636336139323033316232
<span class="m">37666439383131393631333332353731633661396431633834326432363936613331623135666565</span>
6364363039663933620a326563323931643632323031396664646363613636613562366166386439
<span class="m">63653661653037393538356461323239396630643338393231306163343964623866</span>

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>just<span class="w"> </span>decrypt
bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>
Decryption<span class="w"> </span>successful

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>cat<span class="w"> </span>secret-file
Danger,<span class="w"> </span>Will<span class="w"> </span>Robinson
</pre></div>

</pre>

<p>So as you can see, I have <code>secret-file</code> here, and I can encrypt and decrypt
just fine. But if I have that <code>&gt;&gt;</code> in the recipe, add a second file, and a
failure in a command - well then I'll start getting confused...</p>
<p>Follow along with the workflow of adding a file that I'll need encrypted</p>
<blockquote>
<p>Only secret-file is in the just recipe here - I add secret-file2 after</p>
</blockquote>
<pre class='wrapper'>

<div class='copy-wrapper'>

<button class='copy' title='copy code to clipboard' onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('pre').textContent)"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 115.77 122.88" style="enable-background:new 0 0 115.77 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M89.62,13.96v7.73h12.19h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02v0.02 v73.27v0.01h-0.02c-0.01,3.84-1.57,7.33-4.1,9.86c-2.51,2.5-5.98,4.06-9.82,4.07v0.02h-0.02h-61.7H40.1v-0.02 c-3.84-0.01-7.34-1.57-9.86-4.1c-2.5-2.51-4.06-5.98-4.07-9.82h-0.02v-0.02V92.51H13.96h-0.01v-0.02c-3.84-0.01-7.34-1.57-9.86-4.1 c-2.5-2.51-4.06-5.98-4.07-9.82H0v-0.02V13.96v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07V0h0.02h61.7 h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02V13.96L89.62,13.96z M79.04,21.69v-7.73v-0.02h0.02 c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v64.59v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h12.19V35.65 v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07v-0.02h0.02H79.04L79.04,21.69z M105.18,108.92V35.65v-0.02 h0.02c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v73.27v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h61.7h0.02 v0.02c0.91,0,1.75-0.39,2.37-1.01c0.61-0.61,1-1.46,1-2.37h-0.02V108.92L105.18,108.92z"/></g></svg></button>
</div>
        
<div class="highlight"><pre><span></span>nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>just<span class="w"> </span>decrypt
bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>
ERROR!<span class="w"> </span>input<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>vault<span class="w"> </span>encrypted<span class="w"> </span>data.<span class="w"> </span>/var/home/nic/projects/personal/pype.dev/secret-file<span class="w"> </span>is<span class="w"> </span>not<span class="w"> </span>a<span class="w"> </span>vault<span class="w"> </span>encrypted<span class="w"> </span>file<span class="w"> </span><span class="k">for</span><span class="w"> </span>/var/home/nic/projects/personal/pype.dev/secret-file
error:<span class="w"> </span>Recipe<span class="w"> </span><span class="sb">`</span>decrypt<span class="sb">`</span><span class="w"> </span>failed<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">1</span>

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×8<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
✗<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Good - secret-file is already decrypted! So lets add another file&quot;</span>
Good<span class="w"> </span>-<span class="w"> </span>secret-file<span class="w"> </span>is<span class="w"> </span>already<span class="w"> </span>decrypted!<span class="w"> </span>So<span class="w"> </span>lets<span class="w"> </span>add<span class="w"> </span>another<span class="w"> </span>file

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Foo Bar Bam Baz&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>secret-file2<span class="w">                                    </span>

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×8<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Added secret-file2 to my Just recipes&quot;</span>
Added<span class="w"> </span>secret-file2<span class="w"> </span>to<span class="w"> </span>my<span class="w"> </span>Just<span class="w"> </span>recipes

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×8<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>just<span class="w"> </span>encrypt
bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>
Encryption<span class="w"> </span>successful
Encryption<span class="w"> </span>successful

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×7<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
❯<span class="w"> </span>just<span class="w"> </span>decrypt
bws<span class="w"> </span>secret<span class="w"> </span>get<span class="w"> </span><span class="nv">$HOMELAB_BOT_VAULT_KEY_ID</span><span class="w">  </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.value&#39;</span>
ERROR!<span class="w"> </span>Decryption<span class="w"> </span>failed<span class="w"> </span><span class="o">(</span>no<span class="w"> </span>vault<span class="w"> </span>secrets<span class="w"> </span>were<span class="w"> </span>found<span class="w"> </span>that<span class="w"> </span>could<span class="w"> </span>decrypt<span class="o">)</span><span class="w"> </span>on<span class="w"> </span>/var/home/nic/projects/personal/pype.dev/secret-file<span class="w"> </span><span class="k">for</span><span class="w"> </span>/var/home/nic/projects/personal/pype.dev/secret-file
error:<span class="w"> </span>Recipe<span class="w"> </span><span class="sb">`</span>decrypt<span class="sb">`</span><span class="w"> </span>failed<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">1</span>

nic<span class="w"> </span><span class="k">in</span><span class="w"> </span>pype.dev<span class="w">  </span><span class="w"> </span>main<span class="w">  </span><span class="w"> </span>×2<span class="w"> </span><span class="w"> </span>×3<span class="w"> </span><span class="w"> </span>×8<span class="w"> </span>via<span class="w"> </span><span class="w">  </span>v3.11.10<span class="o">(</span>pype-dev<span class="o">)</span><span class="w">  </span><span class="w"> </span><span class="o">(</span>dev<span class="o">)</span><span class="w"> </span>󰒄<span class="w"> </span>
✗<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Oh no!&quot;</span>
</pre></div>

</pre>

<p>So what happened?</p>
<p>Recall that my recipes originally had <code>set -e</code> at the top and used <code>&gt;&gt;</code> to cat
my secret to a file <code>key</code>. Well, when the fir| decryption recipe failed the
<code>key</code> file was left behind. Then when I went to encrypt both of my files the
recipe got the key again and made a keyfile like this:</p>
<pre class='wrapper'>

<div class='copy-wrapper'>

<button class='copy' title='copy code to clipboard' onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('pre').textContent)"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 115.77 122.88" style="enable-background:new 0 0 115.77 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M89.62,13.96v7.73h12.19h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02v0.02 v73.27v0.01h-0.02c-0.01,3.84-1.57,7.33-4.1,9.86c-2.51,2.5-5.98,4.06-9.82,4.07v0.02h-0.02h-61.7H40.1v-0.02 c-3.84-0.01-7.34-1.57-9.86-4.1c-2.5-2.51-4.06-5.98-4.07-9.82h-0.02v-0.02V92.51H13.96h-0.01v-0.02c-3.84-0.01-7.34-1.57-9.86-4.1 c-2.5-2.51-4.06-5.98-4.07-9.82H0v-0.02V13.96v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07V0h0.02h61.7 h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02V13.96L89.62,13.96z M79.04,21.69v-7.73v-0.02h0.02 c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v64.59v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h12.19V35.65 v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07v-0.02h0.02H79.04L79.04,21.69z M105.18,108.92V35.65v-0.02 h0.02c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v73.27v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h61.7h0.02 v0.02c0.91,0,1.75-0.39,2.37-1.01c0.61-0.61,1-1.46,1-2.37h-0.02V108.92L105.18,108.92z"/></g></svg></button>
</div>
        
<div class="highlight"><pre><span></span>secretKey
secretKey
</pre></div>

</pre>

<p>The encryption recipe encrypted the files with this key, removed the key file,
and then the next decryption recipe failed because when it got the key and made
the file it looked like</p>
<pre class='wrapper'>

<div class='copy-wrapper'>

<button class='copy' title='copy code to clipboard' onclick="navigator.clipboard.writeText(this.parentElement.parentElement.querySelector('pre').textContent)"><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 115.77 122.88" style="enable-background:new 0 0 115.77 122.88" xml:space="preserve"><style type="text/css">.st0{fill-rule:evenodd;clip-rule:evenodd;}</style><g><path class="st0" d="M89.62,13.96v7.73h12.19h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02v0.02 v73.27v0.01h-0.02c-0.01,3.84-1.57,7.33-4.1,9.86c-2.51,2.5-5.98,4.06-9.82,4.07v0.02h-0.02h-61.7H40.1v-0.02 c-3.84-0.01-7.34-1.57-9.86-4.1c-2.5-2.51-4.06-5.98-4.07-9.82h-0.02v-0.02V92.51H13.96h-0.01v-0.02c-3.84-0.01-7.34-1.57-9.86-4.1 c-2.5-2.51-4.06-5.98-4.07-9.82H0v-0.02V13.96v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07V0h0.02h61.7 h0.01v0.02c3.85,0.01,7.34,1.57,9.86,4.1c2.5,2.51,4.06,5.98,4.07,9.82h0.02V13.96L89.62,13.96z M79.04,21.69v-7.73v-0.02h0.02 c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v64.59v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h12.19V35.65 v-0.01h0.02c0.01-3.85,1.58-7.34,4.1-9.86c2.51-2.5,5.98-4.06,9.82-4.07v-0.02h0.02H79.04L79.04,21.69z M105.18,108.92V35.65v-0.02 h0.02c0-0.91-0.39-1.75-1.01-2.37c-0.61-0.61-1.46-1-2.37-1v0.02h-0.01h-61.7h-0.02v-0.02c-0.91,0-1.75,0.39-2.37,1.01 c-0.61,0.61-1,1.46-1,2.37h0.02v0.01v73.27v0.02h-0.02c0,0.91,0.39,1.75,1.01,2.37c0.61,0.61,1.46,1,2.37,1v-0.02h0.01h61.7h0.02 v0.02c0.91,0,1.75-0.39,2.37-1.01c0.61-0.61,1-1.46,1-2.37h-0.02V108.92L105.18,108.92z"/></g></svg></button>
</div>
        
<div class="highlight"><pre><span></span>secretKey
</pre></div>

</pre>

<p>So the solution in the end is to remake the <code>key</code> file every time (<code>&gt;</code> instead
of <code>&gt;&gt;</code>), or check if it exists, or handle the error when the recipe fails, or
just keep going (<code>set +e</code>)</p>
<h2 id="fin">Fin <a class="header-anchor" href="#fin"><svg class="heading-permalink" aria-hidden="true" fill="currentColor" focusable="false" height="1em" viewBox="0 0 24 24" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></a></h2>
<p>And that's how I lost some secrets in my homelab once, and how I almost lost a
second time if I hadn't noticed the <code>key</code> file in my file tree</p>

        </section>
    </article>
</section>